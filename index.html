<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phil's Moving Sale - Everything Must Go!</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#f5f5f7;color:#1d1d1f}
.header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);color:#fff;text-align:center;padding:3rem 1rem 2rem}
.header h1{font-size:2.4rem;font-weight:800;margin-bottom:.5rem;letter-spacing:-.5px}
.header .subtitle{font-size:1.1rem;opacity:.85;font-weight:400}
.header .emoji-bar{font-size:1.6rem;margin-top:.8rem;letter-spacing:8px}
.tabs-wrap{position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow-x:auto;-webkit-overflow-scrolling:touch}
.tabs{display:flex;max-width:1200px;margin:0 auto;padding:0 .5rem;gap:4px}
.tabs button{flex-shrink:0;padding:.75rem 1.2rem;border:none;background:none;font-family:inherit;font-size:.9rem;font-weight:500;color:#666;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s}
.tabs button:hover{color:#1d1d1f}
.tabs button.active{color:#0f3460;border-bottom-color:#0f3460;font-weight:600}
.container{max-width:1200px;margin:0 auto;padding:1.5rem 1rem}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:560px){.grid{grid-template-columns:1fr}.header h1{font-size:1.6rem}.header .subtitle{font-size:.95rem}}
.card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06);transition:transform .2s,box-shadow .2s}
.card:hover{transform:translateY(-3px);box-shadow:0 4px 20px rgba(0,0,0,.12)}
.card-gallery{position:relative;height:220px;background:#e8ecf1;overflow:hidden}
.card-gallery .slides{display:flex;height:100%;transition:transform .3s ease}
.card-gallery .slide{min-width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative}
.card-gallery .slide img{width:100%;height:100%;object-fit:cover}
.card-gallery .placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;color:#9ca3af;gap:.5rem;cursor:pointer}
.card-gallery .placeholder:hover{background:#dde3eb}
.card-gallery .placeholder svg{width:48px;height:48px;opacity:.5}
.card-gallery .placeholder span{font-size:.85rem;font-weight:500}
.card-gallery input[type=file]{display:none}
.card-gallery .nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:#fff;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;z-index:10;opacity:0;transition:opacity .2s}
.card-gallery:hover .nav-btn{opacity:1}
.card-gallery .nav-prev{left:24px}
.card-gallery .nav-next{right:24px}
.card-gallery .add-more{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.55);color:#fff;border:none;padding:.3rem .6rem;border-radius:8px;font-size:.75rem;font-weight:600;cursor:pointer;z-index:10;opacity:0;transition:opacity .2s}
.card-gallery:hover .add-more{opacity:1}
.card-gallery .dots{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:10}
.card-gallery .dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.5)}
.card-gallery .dot.active{background:#fff}
.card-gallery .img-count{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.55);color:#fff;padding:.2rem .5rem;border-radius:6px;font-size:.7rem;font-weight:600;z-index:10}
.card-gallery .del-btn{position:absolute;top:8px;left:8px;background:rgba(220,38,38,.85);color:#fff;border:none;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;z-index:10;opacity:0;transition:opacity .2s;line-height:1}
.card-gallery:hover .del-btn{opacity:1}
.card-gallery .del-btn:hover{background:rgba(185,28,28,.95)}
.card-body{padding:1.1rem 1.2rem 1.2rem}
.card-body h3{font-size:1.05rem;font-weight:700;margin-bottom:.35rem;color:#1d1d1f}
.card-price{font-size:.95rem;color:#0f3460;font-weight:600;margin-bottom:.4rem}
.card-price .edit-price{border:1px solid #d1d5db;border-radius:6px;padding:.2rem .4rem;font-family:inherit;font-size:.9rem;font-weight:600;color:#0f3460;width:120px}
.card-desc{font-size:.85rem;color:#6b7280;line-height:1.45;margin-bottom:.7rem}
.card-desc .edit-desc{border:1px solid #d1d5db;border-radius:6px;padding:.3rem .4rem;font-family:inherit;font-size:.85rem;color:#6b7280;width:100%;resize:vertical;min-height:40px}
.card-body .edit-name{border:1px solid #d1d5db;border-radius:6px;padding:.2rem .4rem;font-family:inherit;font-size:1.05rem;font-weight:700;color:#1d1d1f;width:100%;margin-bottom:.35rem}
.editable{cursor:pointer;border-bottom:1px dashed transparent;transition:border-color .2s}
.editable:hover{border-bottom-color:#d1d5db}
.badge{display:inline-block;padding:.25rem .7rem;border-radius:99px;font-size:.75rem;font-weight:600;letter-spacing:.3px}
.badge-available{background:#d1fae5;color:#065f46}
.badge-sold{background:#fee2e2;color:#991b1b}
.contact{text-align:center;padding:3rem 1rem;background:#fff;margin-top:2rem;border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.contact h2{font-size:1.5rem;font-weight:700;margin-bottom:.5rem}
.contact p{color:#6b7280;margin-bottom:1.2rem}
.contact a{display:inline-flex;align-items:center;gap:.5rem;background:#25d366;color:#fff;padding:.8rem 2rem;border-radius:99px;text-decoration:none;font-weight:600;font-size:1rem;transition:background .2s}
.contact a:hover{background:#1da851}
.bulk-upload{text-align:center;margin-bottom:1.5rem;padding:1.5rem;background:#fff;border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);border:2px dashed #d1d5db;cursor:pointer;transition:all .2s}
.bulk-upload:hover{border-color:#0f3460;background:#f0f4ff}
.bulk-upload input{display:none}
.bulk-upload h3{font-size:1rem;font-weight:600;color:#1d1d1f;margin-bottom:.3rem}
.bulk-upload p{font-size:.85rem;color:#6b7280}
.bulk-upload .icon{font-size:2rem;margin-bottom:.5rem}
.bulk-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center}
.bulk-modal-overlay.show{display:flex}
.bulk-modal{background:#fff;border-radius:16px;padding:2rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,.2)}
.bulk-modal h3{font-size:1.2rem;font-weight:700;margin-bottom:1rem}
.bulk-modal .assign-row{display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem;padding:.5rem;background:#f9fafb;border-radius:10px}
.bulk-modal .assign-row img{width:60px;height:60px;object-fit:cover;border-radius:8px;flex-shrink:0}
.bulk-modal .assign-row select{flex:1;padding:.5rem;border:1px solid #d1d5db;border-radius:8px;font-family:inherit;font-size:.85rem}
.bulk-modal .btn-row{display:flex;gap:.8rem;margin-top:1.2rem;justify-content:flex-end}
.bulk-modal button{padding:.6rem 1.4rem;border-radius:10px;border:none;font-family:inherit;font-weight:600;font-size:.9rem;cursor:pointer}
.bulk-modal .btn-cancel{background:#e5e7eb;color:#374151}
.bulk-modal .assign-row,.reorder-modal .reorder-row{position:relative;cursor:grab;user-select:none}
.bulk-modal .assign-row.dragging,.reorder-modal .reorder-row.dragging{opacity:.4;background:#dbeafe}
.bulk-modal .assign-row.drag-over,.reorder-modal .reorder-row.drag-over{border-top:3px solid #0f3460}
.bulk-modal .order-num,.reorder-modal .order-num{position:absolute;top:50%;left:-24px;transform:translateY(-50%);font-size:.75rem;font-weight:700;color:#9ca3af;width:20px;text-align:center}
.card-gallery .reorder-btn{position:absolute;bottom:8px;right:90px;background:rgba(0,0,0,.55);color:#fff;border:none;padding:.3rem .6rem;border-radius:8px;font-size:.75rem;font-weight:600;cursor:pointer;z-index:10;opacity:0;transition:opacity .2s}
.card-gallery:hover .reorder-btn{opacity:1}
.reorder-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center}
.reorder-modal-overlay.show{display:flex}
.reorder-modal{background:#fff;border-radius:16px;padding:2rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,.2)}
.reorder-modal h3{font-size:1.2rem;font-weight:700;margin-bottom:.5rem}
.reorder-modal .reorder-row{display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem;padding:.5rem;background:#f9fafb;border-radius:10px}
.reorder-modal .reorder-row img{width:80px;height:60px;object-fit:cover;border-radius:8px;flex-shrink:0}
.reorder-modal .btn-row{display:flex;gap:.8rem;margin-top:1.2rem;justify-content:flex-end}
.reorder-modal button{padding:.6rem 1.4rem;border-radius:10px;border:none;font-family:inherit;font-weight:600;font-size:.9rem;cursor:pointer}
.reorder-modal .btn-cancel{background:#e5e7eb;color:#374151}
.reorder-modal .btn-save{background:#0f3460;color:#fff}
.bulk-modal .btn-save{background:#0f3460;color:#fff}
.bulk-modal .btn-save:hover{background:#1a4a7a}
.card{position:relative;overflow:visible}
.card .move-dpad{position:absolute;bottom:8px;left:8px;z-index:20;opacity:0;transition:opacity .2s;display:grid;grid-template-columns:26px 26px 26px;grid-template-rows:26px 26px 26px;gap:2px}
.card:hover .move-dpad{opacity:1}
.move-dpad button{width:26px;height:26px;border:none;border-radius:5px;background:rgba(15,52,96,.8);color:#fff;cursor:pointer;font-size:.7rem;display:flex;align-items:center;justify-content:center;transition:background .15s;padding:0;line-height:1}
.move-dpad button:hover{background:rgba(15,52,96,1)}
.move-dpad .dpad-up{grid-column:2;grid-row:1}
.move-dpad .dpad-left{grid-column:1;grid-row:2}
.move-dpad .dpad-right{grid-column:3;grid-row:2}
.move-dpad .dpad-down{grid-column:2;grid-row:3}
.lightbox{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:300;align-items:center;justify-content:center;flex-direction:column}
.lightbox.show{display:flex}
.lightbox img{max-width:90%;max-height:80%;object-fit:contain;border-radius:8px}
.lightbox .lb-close{position:absolute;top:20px;right:20px;background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;z-index:310;width:40px;height:40px;display:flex;align-items:center;justify-content:center}
.lightbox .lb-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.15);border:none;color:#fff;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:1.3rem;display:flex;align-items:center;justify-content:center;transition:background .2s}
.lightbox .lb-nav:hover{background:rgba(255,255,255,.3)}
.lightbox .lb-prev{left:16px}
.lightbox .lb-next{right:16px}
.lightbox .lb-caption{color:#fff;margin-top:1rem;font-size:.95rem;font-weight:500;text-align:center}
.lightbox .lb-counter{color:rgba(255,255,255,.6);font-size:.8rem;margin-top:.3rem}
.footer{text-align:center;padding:2rem 1rem;color:#9ca3af;font-size:.8rem}
.cat-select{font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;font-weight:600;border:1px solid #e5e7eb;border-radius:8px;padding:.3rem .5rem;font-family:inherit;color:#6b7280;background:#f9fafb;cursor:pointer;margin-bottom:.3rem;appearance:auto;-webkit-appearance:menulist;min-width:100px}
.cat-select:hover{border-color:#0f3460;color:#0f3460}
.cat-select:focus{outline:2px solid #0f3460;outline-offset:-1px;border-color:#0f3460;color:#0f3460}
.card .delete-item{position:absolute;top:8px;right:8px;background:rgba(220,38,38,.9);color:#fff;border:none;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:.8rem;font-weight:700;display:flex;align-items:center;justify-content:center;z-index:20;opacity:0;transition:opacity .2s;line-height:1}
.card:hover .delete-item{opacity:1}
.card .delete-item:hover{background:rgba(185,28,28,1)}
.card{position:relative}
.add-item-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.06);border:2px dashed #d1d5db;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:320px;cursor:pointer;transition:all .2s}
.add-item-card:hover{border-color:#0f3460;background:#f0f4ff;transform:translateY(-3px)}
.add-item-card .plus{font-size:3rem;color:#9ca3af;font-weight:300;line-height:1}
.add-item-card span{font-size:.95rem;font-weight:600;color:#6b7280;margin-top:.5rem}
.add-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center}
.add-modal-overlay.show{display:flex}
.add-modal{background:#fff;border-radius:16px;padding:2rem;max-width:450px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,.2)}
.add-modal h3{font-size:1.2rem;font-weight:700;margin-bottom:1rem}
.add-modal label{display:block;font-size:.85rem;font-weight:600;color:#374151;margin-bottom:.3rem;margin-top:.8rem}
.add-modal input,.add-modal select,.add-modal textarea{width:100%;padding:.5rem .7rem;border:1px solid #d1d5db;border-radius:8px;font-family:inherit;font-size:.9rem}
.add-modal textarea{resize:vertical;min-height:60px}
.add-modal .btn-row{display:flex;gap:.8rem;margin-top:1.5rem;justify-content:flex-end}
.add-modal button{padding:.6rem 1.4rem;border-radius:10px;border:none;font-family:inherit;font-weight:600;font-size:.9rem;cursor:pointer}
.add-modal .btn-cancel{background:#e5e7eb;color:#374151}
.add-modal .btn-add{background:#0f3460;color:#fff}
.add-modal .btn-add:hover{background:#1a4a7a}
.list-view{display:none;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06)}
.list-view.active{display:block}
.list-row{display:flex;align-items:center;padding:.75rem 1.2rem;cursor:pointer;transition:background .15s;border-bottom:1px solid #f0f0f0;gap:1rem}
.list-row:last-child{border-bottom:none}
.list-row:nth-child(even){background:#fafbfc}
.list-row:hover{background:#eef2ff}
.list-row .row-name{font-weight:700;font-size:.95rem;color:#1d1d1f;flex-shrink:0;min-width:140px}
.list-row .row-desc{flex:1;font-size:.85rem;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.list-row .row-cat{font-size:.7rem;font-weight:600;background:#dbeafe;color:#1e40af;padding:.2rem .6rem;border-radius:99px;white-space:nowrap;flex-shrink:0}
.list-row .row-price{font-weight:600;font-size:.9rem;color:#0f3460;white-space:nowrap;text-align:right;flex-shrink:0;min-width:80px}
.list-row .row-status{font-size:.7rem;font-weight:600;padding:.2rem .5rem;border-radius:99px;flex-shrink:0}
.list-row .row-status.available{background:#dcfce7;color:#166534}
.list-row .row-status.sold{background:#fee2e2;color:#991b1b}
@media(max-width:560px){.list-row{flex-wrap:wrap;gap:.3rem;padding:.7rem 1rem}.list-row .row-desc{display:none}.list-row .row-name{flex:1}.list-row .row-price{margin-left:auto}}
/* Deposit popup overlay */
.deposit-popup-overlay{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:500;align-items:center;justify-content:center;animation:fadeIn .3s}
.deposit-popup-overlay.hidden{display:none}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.deposit-popup{background:#fff;border-radius:20px;padding:2.5rem 2rem;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);text-align:center;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.deposit-popup .popup-icon{font-size:3rem;margin-bottom:.8rem}
.deposit-popup h2{font-size:1.4rem;font-weight:800;color:#1d1d1f;margin-bottom:.6rem}
.deposit-popup .popup-highlight{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);color:#fff;border-radius:12px;padding:1.2rem;margin:1rem 0;font-size:.95rem;line-height:1.5}
.deposit-popup .popup-highlight strong{color:#fbbf24}
.deposit-popup .popup-items{font-size:.85rem;color:#6b7280;margin:.8rem 0;line-height:1.6}
.deposit-popup .popup-items strong{color:#1d1d1f}
.deposit-popup .popup-btn{background:#0f3460;color:#fff;border:none;padding:.8rem 2.5rem;border-radius:99px;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;transition:background .2s;margin-top:.5rem}
.deposit-popup .popup-btn:hover{background:#1a4a7a}
/* Deposit banner */
.deposit-banner{background:linear-gradient(135deg,#1a1a2e,#0f3460);color:#fff;text-align:center;padding:1.4rem 1.2rem;font-size:1.15rem;font-weight:600;line-height:1.6;letter-spacing:.2px;position:sticky;top:0;z-index:150}
.deposit-banner strong{color:#fbbf24}
.deposit-banner a{color:#fbbf24;text-decoration:underline}
/* Late pickup tag on cards */
.late-pickup-tag{display:inline-flex;align-items:center;gap:.3rem;background:#fef3c7;color:#92400e;font-size:.7rem;font-weight:700;padding:.2rem .6rem;border-radius:99px;margin-bottom:.3rem;letter-spacing:.3px}
/* Card drag-and-drop */
.card .drag-handle{position:absolute;top:0;left:50%;transform:translateX(-50%);z-index:25;opacity:0;transition:opacity .15s;cursor:grab;background:rgba(15,52,96,.85);color:#fff;padding:3px 14px;border-radius:0 0 8px 8px;font-size:.7rem;font-weight:600;display:flex;align-items:center;gap:4px;user-select:none;white-space:nowrap}
.card:hover .drag-handle{opacity:1}
.drag-handle:active{cursor:grabbing}
.card.dragging{opacity:.3;transform:scale(.95)!important;transition:opacity .15s,transform .15s}
/* Freeze all cards in place during drag ‚Äî only the drag-over target gets highlighted */
.grid.is-dragging .card{transform:none!important;box-shadow:0 1px 4px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06)!important}
.grid.is-dragging .card.dragging{opacity:.3;transform:scale(.95)!important}
.card.drag-over{outline:3px solid #0f3460;outline-offset:-3px;box-shadow:0 0 0 4px rgba(15,52,96,.3)!important}
.card.drag-over::after{content:'Drop here';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(15,52,96,.9);color:#fff;padding:.5rem 1.2rem;border-radius:10px;font-size:.85rem;font-weight:700;z-index:30;pointer-events:none}
.touch-drag-ghost{position:fixed;pointer-events:none;z-index:1000;opacity:.8;transform:rotate(1.5deg);box-shadow:0 15px 50px rgba(0,0,0,.35);border-radius:16px;overflow:hidden;transition:none}
@media(max-width:560px){.card .drag-handle{opacity:.6;font-size:.65rem;padding:2px 10px}}
</style>
</head>
<body>
<!-- Deposit popup on first visit -->
<div class="deposit-popup-overlay" id="depositPopup">
<div class="deposit-popup">
<div class="popup-icon">üè†‚úàÔ∏è</div>
<h2>Moving to Thailand ‚Äî Everything Must Go!</h2>
<div class="popup-highlight">
üìÖ Some items are <strong>available for pickup from 24 or 28 March only</strong> (still in use until we move).<br><br>
üí∞ To secure these items, a <strong>50% non-refundable deposit</strong> is required. Balance due on pickup day.
</div>
<div class="popup-items">
<strong>24 March:</strong> Washer &amp; Dryer<br><strong>28 March:</strong> Beds, Fridge, Lounge Chairs &amp; other daily-use items
</div>
<button class="popup-btn" id="popupClose">üëç Got it, let me browse!</button>
</div>
</div>

<!-- Persistent deposit banner -->
<div class="deposit-banner">
üìÖ Some items <strong>available from 24 or 28 March only</strong> ‚Äî 50% deposit required to secure. <a href="tel:0412397443">Call Phil</a> to arrange.
</div>

<div class="header">
<h1>Phil's Moving Sale - Everything Must Go!</h1>
<p class="subtitle">Chinderah, NSW - Moving to Thailand, all items must sell!</p>
<div class="emoji-bar">üè† ‚úàÔ∏è üáπüá≠</div>
<p style="margin-top:1rem;font-size:1.05rem;opacity:.9;font-weight:500">üìû Contact Phil @ <a href="tel:0412397443" style="color:#fff;text-decoration:underline">0412 397 443</a> - Chinderah, NSW</p>
<div style="display:flex;gap:.5rem;justify-content:center;margin-top:1.2rem;flex-wrap:wrap">
<a href="index.html" style="color:#fff;text-decoration:none;padding:.5rem 1.2rem;border-radius:99px;font-size:.9rem;font-weight:600;border:2px solid rgba(255,255,255,.6);background:rgba(255,255,255,.2)">üìã Admin</a>
<a href="all-items.html" style="color:#fff;text-decoration:none;padding:.5rem 1.2rem;border-radius:99px;font-size:.9rem;font-weight:600;border:2px solid rgba(255,255,255,.3)">üõí All Items</a>
</div>
</div>
<div class="tabs-wrap"><div class="tabs" id="tabs"></div></div>
<div class="container">
<div style="display:flex;gap:1rem;margin-bottom:1.5rem">
<div class="bulk-upload" id="bulkUpload" style="flex:1;margin-bottom:0">
<input type="file" id="bulkInput" accept="image/*" multiple>
<div class="icon">üì∏</div>
<h3>Bulk Upload Photos</h3>
<p>Drop multiple images here or click to select - then assign each to an item</p>
</div>
<div class="bulk-upload" id="bulkDownload" style="flex:1;margin-bottom:0;border-color:#0f3460;background:#f0f4ff">
<div class="icon">üì•</div>
<h3>Download All Photos</h3>
<p>Download all photos as a ZIP - organized into folders by item name</p>
</div>
</div>
<div class="bulk-modal-overlay" id="bulkModal">
<div class="bulk-modal">
<h3>Assign photos to items</h3>
<p style="font-size:.8rem;color:#9ca3af;margin-bottom:.8rem">Drag rows to reorder photos</p>
<div id="bulkAssignList" style="padding-left:28px"></div>
<div class="btn-row">
<button class="btn-cancel" id="bulkCancel">Cancel</button>
<button class="btn-save" id="bulkSave">Add Photos</button>
</div>
</div>
</div>
<div class="reorder-modal-overlay" id="reorderModal">
<div class="reorder-modal">
<h3>Reorder Photos</h3>
<p style="font-size:.8rem;color:#9ca3af;margin-bottom:.8rem">Drag to reorder</p>
<div id="reorderList" style="padding-left:28px"></div>
<div class="btn-row">
<button class="btn-cancel" id="reorderCancel">Cancel</button>
<button class="btn-save" id="reorderSave">Save Order</button>
</div>
</div>
</div>
<div class="grid" id="grid"></div>
<div class="list-view" id="listView"></div>
<div class="add-modal-overlay" id="addModal">
<div class="add-modal">
<h3>Add New Item</h3>
<label>Item Name</label>
<input type="text" id="addName" placeholder="e.g. Coffee Table">
<label>Category</label>
<select id="addCat"></select>
<label>Description</label>
<textarea id="addDesc" placeholder="Brief description..."></textarea>
<label>Price</label>
<input type="text" id="addPrice" placeholder="e.g. $50 or Contact for price">
<div class="btn-row">
<button class="btn-cancel" id="addCancel">Cancel</button>
<button class="btn-add" id="addSave">Add Item</button>
</div>
</div>
</div>
<div class="contact">
<h2>Interested in something?</h2>
<p>Get in touch - happy to answer questions or arrange a viewing in Chinderah.</p>
<a href="tel:0412397443" style="display:inline-flex;align-items:center;gap:.5rem;background:#0f3460;color:#fff;padding:.7rem 1.5rem;border-radius:10px;text-decoration:none;font-weight:600;font-size:1rem">
üìû Contact Phil @ 0412 397 443 - Chinderah, NSW
</a>
</div>
</div>
<div class="lightbox" id="lightbox">
<button class="lb-close" id="lbClose">‚úï</button>
<button class="lb-nav lb-prev" id="lbPrev">‚Äπ</button>
<button class="lb-nav lb-next" id="lbNext">‚Ä∫</button>
<img id="lbImg" src="">
<div class="lb-caption" id="lbCaption"></div>
<div class="lb-counter" id="lbCounter"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<div class="footer">Last updated: 16 February 2026 &nbsp;|&nbsp; Chinderah, NSW</div>

<script>
// Global data loaded from API
let items = [];
let photos = {}; // photos[item_id] = [photo objects]
let slidePos = {}; // slidePos[item_id] = current slide index

const cats=["All","Furniture","Appliances","Kitchen","Electronics","Bedroom/Bathroom","Car","Misc"];
const tabsEl=document.getElementById("tabs");
const gridEl=document.getElementById("grid");

const svg=`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/></svg>`;

// API helper functions
async function fetchAPI(endpoint, options = {}) {
  try {
    const response = await fetch(`/api/${endpoint}`, {
      headers: { 'Content-Type': 'application/json' },
      ...options
    });
    if (!response.ok) throw new Error(`API error: ${response.status}`);
    return await response.json();
  } catch (error) {
    console.error(`API ${endpoint} error:`, error);
    return null;
  }
}

// Load all data from API
async function loadData() {
  const itemsData = await fetchAPI('items');
  if (itemsData) {
    items = itemsData;
  }

  const photosData = await fetchAPI('photos');
  if (photosData) {
    photos = photosData;
    Object.keys(photos).forEach(itemId => {
      slidePos[itemId] = 0;
    });
  }
}

// API operations
async function updateItemInDB(itemId, updates) {
  const item = items.find(i => i.id === itemId);
  if (!item) return null;
  
  const updatedItem = { ...item, ...updates };
  return await fetchAPI('items', {
    method: 'PUT',
    body: JSON.stringify(updatedItem)
  });
}

async function deleteItemFromDB(itemId) {
  return await fetchAPI('items', {
    method: 'DELETE',
    body: JSON.stringify({ id: itemId })
  });
}

async function addPhotoToDB(itemId, photoDataUrl) {
  return await fetchAPI('photos', {
    method: 'POST',
    body: JSON.stringify({ item_id: itemId, photo: photoDataUrl })
  });
}

async function deletePhotoFromDB(photoId) {
  return await fetchAPI('photos', {
    method: 'DELETE',
    body: JSON.stringify({ id: photoId })
  });
}

async function reorderPhotos(itemId, photoIds) {
  return await fetchAPI('photos', {
    method: 'PUT',
    body: JSON.stringify({ item_id: itemId, photoIds })
  });
}

function render(cat){
  gridEl.innerHTML="";
  const list=cat==="All"?items:items.filter(item=>item.category===cat);
  list.forEach((item)=>{
    const itemId=item.id;
    if(!photos[itemId]) photos[itemId]=[];
    if(!slidePos[itemId]) slidePos[itemId]=0;
    const imgs=photos[itemId].map(p=>p.url||p); // Handle both {url:...} and direct URLs
    const pos=slidePos[itemId];

    let galleryInner='';
    if(imgs.length===0){
      galleryInner=`<div class="slides"><div class="slide"><div class="placeholder">${svg}<span>Click to add photos</span></div></div></div>`;
    } else {
      const slidesHTML=imgs.map(src=>`<div class="slide"><img src="${src}"></div>`).join('');
      const dotsHTML=imgs.length>1?`<div class="dots">${imgs.map((_,i)=>`<div class="dot${i===pos?' active':''}"></div>`).join('')}</div>`:'';
      const countHTML=imgs.length>1?`<div class="img-count">${pos+1} / ${imgs.length}</div>`:'';
      const navHTML=imgs.length>1?`<button class="nav-btn nav-prev" data-dir="-1">‚Äπ</button><button class="nav-btn nav-next" data-dir="1">‚Ä∫</button>`:'';
      const delHTML=`<button class="del-btn" title="Delete this photo">‚úï</button>`;
      const reorderHTML=imgs.length>1?`<button class="reorder-btn" data-item-id="${itemId}">‚Üï Reorder</button>`:'';
      galleryInner=`<div class="slides" style="transform:translateX(-${pos*100}%)">${slidesHTML}</div>${dotsHTML}${countHTML}${navHTML}${delHTML}${reorderHTML}<button class="add-more">+ Add photo</button>`;
    }

    const name=item.name;
    const price=item.price||'Contact for price';
    const desc=item.description||'No description';
    const cat=item.category||'Misc';
    const status=item.status||'available';
    const badgeClass=status==='sold'?'badge-sold':'badge-available';
    const badgeText=status==='sold'?'Sold':'Available';
    const allCats=["Furniture","Appliances","Kitchen","Electronics","Bedroom/Bathroom","Car","Misc"];
    const catOptionsHTML=allCats.map(c=>`<option value="${c}"${c===cat?' selected':''}>${c}</option>`).join('');
    const latePickupHTML=(typeof LATE_PICKUP_24MAR!=='undefined'&&LATE_PICKUP_24MAR.some(lp=>name.toLowerCase().includes(lp)))?'<div class="late-pickup-tag">üìÖ Available from 24 March ‚Äî 50% deposit</div>':(typeof LATE_PICKUP_28MAR!=='undefined'&&LATE_PICKUP_28MAR.some(lp=>name.toLowerCase().includes(lp)))?'<div class="late-pickup-tag">üìÖ Available from 28 March ‚Äî 50% deposit</div>':'';

    gridEl.innerHTML+=`<div class="card" data-item-id="${itemId}"><div class="drag-handle">‚†ø Drag</div><button class="delete-item" data-item-id="${itemId}" title="Delete this item">‚úï</button><div class="move-dpad"><button class="dpad-up move-up-btn" data-item-id="${itemId}" title="Move up">‚ñ≤</button><button class="dpad-left move-left" data-item-id="${itemId}" title="Move left">‚óÄ</button><button class="dpad-right move-right-btn" data-item-id="${itemId}" title="Move right">‚ñ∂</button><button class="dpad-down move-down-btn" data-item-id="${itemId}" title="Move down">‚ñº</button></div><div class="card-gallery" data-item-id="${itemId}">${galleryInner}<input type="file" accept="image/*" multiple></div><div class="card-body">${latePickupHTML}<select class="cat-select" data-item-id="${itemId}">${catOptionsHTML}</select><h3 class="editable" data-item-id="${itemId}" data-field="name">${name}</h3><div class="card-price editable" data-item-id="${itemId}" data-field="price">${price}</div><p class="card-desc editable" data-item-id="${itemId}" data-field="description">${desc}</p><span class="badge ${badgeClass}">${badgeText}</span></div></div>`;
  });
  // Add "Add New Item" card at end
  gridEl.innerHTML+=`<div class="add-item-card" id="addItemCard"><div class="plus">+</div><span>Add New Item</span></div>`;

  // Attach handlers
  gridEl.querySelectorAll('.card-gallery').forEach(el=>{
    const itemId=parseInt(el.getAttribute('data-item-id'));
    const input=el.querySelector('input[type=file]');
    const placeholder=el.querySelector('.placeholder');
    const addBtn=el.querySelector('.add-more');

    // Click placeholder to add first photo(s)
    if(placeholder) placeholder.addEventListener('click',()=>input.click());
    // Click + Add photo button
    if(addBtn) addBtn.addEventListener('click',e=>{e.stopPropagation();input.click();});

    // Nav buttons
    el.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click',e=>{
        e.stopPropagation();
        const dir=parseInt(btn.getAttribute('data-dir'));
        const len=photos[itemId]?.length||0;
        slidePos[itemId]=(slidePos[itemId]+dir+len)%len;
        const activeTab=tabsEl.querySelector('button.active').textContent;
        render(activeTab);
      });
    });

    // Click image to open lightbox
    el.querySelectorAll('.slide img').forEach((img,si)=>{
      img.style.cursor='zoom-in';
      img.addEventListener('click',e=>{e.stopPropagation();openLightbox(itemId,si);});
    });

    // Delete current photo
    const delBtn=el.querySelector('.del-btn');
    if(delBtn) delBtn.addEventListener('click',async e=>{
      e.stopPropagation();
      const delPhotoIdx=slidePos[itemId];
      const photoToDelete=photos[itemId][delPhotoIdx];
      if(photoToDelete) {
        await deletePhotoFromDB(photoToDelete.id);
        photos[itemId].splice(delPhotoIdx,1);
        if(slidePos[itemId]>=photos[itemId].length) slidePos[itemId]=Math.max(0,photos[itemId].length-1);
        const activeTab=tabsEl.querySelector('button.active').textContent;
        render(activeTab);
      }
    });

    // Reorder photos button
    const reorderBtn=el.querySelector('.reorder-btn');
    if(reorderBtn) reorderBtn.addEventListener('click',e=>{
      e.stopPropagation();
      openReorderModal(itemId);
    });

    // Inline editing for name, price, description
    el.closest('.card').querySelectorAll('.editable').forEach(edEl=>{
      edEl.setAttribute('tabindex','0');
      async function startEdit(){
        if(edEl.querySelector('textarea,input')) return; // already editing
        const itemId=parseInt(edEl.getAttribute('data-item-id'));
        const field=edEl.getAttribute('data-field');
        const current=edEl.textContent;
        
        if(field==='description'){
          edEl.innerHTML=`<textarea class="edit-desc">${current}</textarea>`;
          const ta=edEl.querySelector('textarea');
          ta.focus();
          ta.addEventListener('blur',async()=>{
            const item=items.find(i=>i.id===itemId);
            if(item) {
              item[field]=ta.value;
              await updateItemInDB(itemId,{[field]:ta.value});
              const activeTab=tabsEl.querySelector('button.active').textContent;
              render(activeTab);
            }
          });
          ta.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();ta.blur();}});
        } else {
          const inputType='text';
          edEl.innerHTML=`<input class="edit-${field}" type="${inputType}" value="${current}">`;
          const inp=edEl.querySelector('input');
          inp.focus();
          inp.select();
          inp.addEventListener('blur',async()=>{
            const item=items.find(i=>i.id===itemId);
            if(item) {
              item[field]=inp.value;
              await updateItemInDB(itemId,{[field]:inp.value});
              const activeTab=tabsEl.querySelector('button.active').textContent;
              render(activeTab);
            }
          });
          inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();});
        }
      }
      edEl.addEventListener('click',startEdit);
      edEl.addEventListener('focus',startEdit);
    });

    // Category dropdown change
    el.closest('.card').querySelectorAll('.cat-select').forEach(sel=>{
      sel.addEventListener('change',async function(){
        const itemId=parseInt(sel.getAttribute('data-item-id'));
        const item=items.find(i=>i.id===itemId);
        if(item) {
          item.category=sel.value;
          await updateItemInDB(itemId,{category:sel.value});
          const activeTab=tabsEl.querySelector('button.active').textContent;
          render(activeTab);
        }
      });
    });

    // Delete item button
    el.closest('.card').querySelector('.delete-item')?.addEventListener('click',async e=>{
      e.stopPropagation();
      const itemId=parseInt(e.currentTarget.getAttribute('data-item-id'));
      const item=items.find(i=>i.id===itemId);
      if(item && confirm(`Delete "${item.name}"? This cannot be undone.`)){
        await deleteItemFromDB(itemId);
        // Remove from local arrays
        items=items.filter(i=>i.id!==itemId);
        delete photos[itemId];
        delete slidePos[itemId];
        const activeTab=tabsEl.querySelector('button.active').textContent;
        render(activeTab);
      }
    });

    // File upload
    input.addEventListener('change',async e=>{
      const files=Array.from(e.target.files);
      if(!files.length)return;
      let loaded=0;
      for(const file of files) {
        const reader=new FileReader();
        reader.onload=async ev=>{
          const compressed=await compressImage(ev.target.result);
          const newPhoto=await addPhotoToDB(itemId,compressed);
          if(newPhoto) {
            if(!photos[itemId]) photos[itemId]=[];
            photos[itemId].push({id:newPhoto.id, url:newPhoto.photo_url||newPhoto.url, sort_order:newPhoto.sort_order});
            slidePos[itemId]=photos[itemId].length-1;
          }
          loaded++;
          if(loaded===files.length){
            const activeTab=tabsEl.querySelector('button.active').textContent;
            render(activeTab);
          }
        };
        reader.readAsDataURL(file);
      }
    });
  });
  // Initialize card drag-and-drop after rendering
  initCardDrag();
}

// Move/reorder items
function getGridCols(){
  const w=window.innerWidth;
  if(w<=560)return 1;
  if(w<=900)return 2;
  return 3;
}

async function moveItem(itemId, direction, steps=1) {
  const item = items.find(i => i.id === itemId);
  if (!item) return;
  
  const success = await fetchAPI('reorder', {
    method: 'POST',
    body: JSON.stringify({ item_id: itemId, direction, steps })
  });
  
  if (success) {
    await loadData();
    const activeTab = tabsEl.querySelector('button.active').textContent;
    render(activeTab);
  }
}

// === Card Drag & Drop ===
let cardDragId = null;

function initCardDrag() {
  const cards = gridEl.querySelectorAll('.card[data-item-id]');

  cards.forEach(card => {
    const handle = card.querySelector('.drag-handle');
    if (!handle) return;

    // Desktop: only allow drag when mousedown is on the handle
    card.addEventListener('mousedown', e => {
      card.draggable = !!e.target.closest('.drag-handle');
    });

    card.addEventListener('dragstart', e => {
      if (!card.draggable) { e.preventDefault(); return; }
      cardDragId = parseInt(card.getAttribute('data-item-id'));
      card.classList.add('dragging');
      gridEl.classList.add('is-dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', String(cardDragId));
      try { e.dataTransfer.setDragImage(card, card.offsetWidth / 2, 30); } catch(err) {}
    });

    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      card.draggable = false;
      gridEl.classList.remove('is-dragging');
      gridEl.querySelectorAll('.drag-over').forEach(c => c.classList.remove('drag-over'));
      cardDragId = null;
    });

    card.addEventListener('dragover', e => {
      if (!cardDragId) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const targetId = parseInt(card.getAttribute('data-item-id'));
      if (targetId !== cardDragId && !card.classList.contains('dragging')) {
        gridEl.querySelectorAll('.drag-over').forEach(c => c.classList.remove('drag-over'));
        card.classList.add('drag-over');
      }
    });

    card.addEventListener('dragleave', e => {
      if (!card.contains(e.relatedTarget)) card.classList.remove('drag-over');
    });

    card.addEventListener('drop', async e => {
      e.preventDefault();
      card.classList.remove('drag-over');
      const targetId = parseInt(card.getAttribute('data-item-id'));
      if (cardDragId && cardDragId !== targetId) {
        await reorderCards(cardDragId, targetId);
      }
      cardDragId = null;
    });

    // === Touch drag support (mobile) ===
    let touchGhost = null;
    let isTouchDragging = false;

    handle.addEventListener('touchstart', e => {
      const touch = e.touches[0];
      isTouchDragging = true;
      cardDragId = parseInt(card.getAttribute('data-item-id'));
      card.classList.add('dragging');
      gridEl.classList.add('is-dragging');

      touchGhost = card.cloneNode(true);
      touchGhost.className = 'touch-drag-ghost';
      touchGhost.style.width = card.offsetWidth + 'px';
      touchGhost.style.left = (touch.clientX - card.offsetWidth / 2) + 'px';
      touchGhost.style.top = (touch.clientY - 40) + 'px';
      document.body.appendChild(touchGhost);

      if (navigator.vibrate) navigator.vibrate(30);
    }, { passive: true });

    handle.addEventListener('touchmove', e => {
      if (!isTouchDragging) return;
      e.preventDefault();
      const touch = e.touches[0];

      if (touchGhost) {
        touchGhost.style.left = (touch.clientX - touchGhost.offsetWidth / 2) + 'px';
        touchGhost.style.top = (touch.clientY - 40) + 'px';
      }

      // Find card under touch point (hide ghost temporarily)
      if (touchGhost) touchGhost.style.display = 'none';
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      if (touchGhost) touchGhost.style.display = '';

      const targetCard = el?.closest('.card[data-item-id]');
      gridEl.querySelectorAll('.drag-over').forEach(c => c.classList.remove('drag-over'));
      if (targetCard) {
        const targetId = parseInt(targetCard.getAttribute('data-item-id'));
        if (targetId !== cardDragId) targetCard.classList.add('drag-over');
      }
    }, { passive: false });

    handle.addEventListener('touchend', async () => {
      if (!isTouchDragging) return;
      isTouchDragging = false;
      card.classList.remove('dragging');
      gridEl.classList.remove('is-dragging');

      if (touchGhost) { touchGhost.remove(); touchGhost = null; }

      const targetCard = gridEl.querySelector('.drag-over');
      gridEl.querySelectorAll('.drag-over').forEach(c => c.classList.remove('drag-over'));

      if (targetCard) {
        const targetId = parseInt(targetCard.getAttribute('data-item-id'));
        if (cardDragId && cardDragId !== targetId) {
          await reorderCards(cardDragId, targetId);
        }
      }
      cardDragId = null;
    });

    handle.addEventListener('touchcancel', () => {
      isTouchDragging = false;
      card.classList.remove('dragging');
      gridEl.classList.remove('is-dragging');
      if (touchGhost) { touchGhost.remove(); touchGhost = null; }
      gridEl.querySelectorAll('.drag-over').forEach(c => c.classList.remove('drag-over'));
      cardDragId = null;
    });
  });
}

async function reorderCards(fromId, toId) {
  const fromIdx = items.findIndex(i => i.id === fromId);
  const toIdx = items.findIndex(i => i.id === toId);
  if (fromIdx === -1 || toIdx === -1) return;

  // Move the item in the array
  const [moved] = items.splice(fromIdx, 1);
  items.splice(toIdx, 0, moved);

  // Update sort_order locally
  items.forEach((item, i) => item.sort_order = i);

  // Re-render immediately for snappy feedback
  const activeTab = tabsEl.querySelector('button.active').textContent;
  render(activeTab);

  // Persist to API
  const ordered_ids = items.map(i => i.id);
  await fetchAPI('reorder', {
    method: 'POST',
    body: JSON.stringify({ ordered_ids })
  });
}

// Image compression - resize to max 1200px and compress to JPEG
function compressImage(dataUrl,maxWidth=1200,quality=0.8){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.width,h=img.height;
      if(w>maxWidth){h=Math.round(h*(maxWidth/w));w=maxWidth;}
      const canvas=document.createElement('canvas');
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg',quality));
    };
    img.src=dataUrl;
  });
}

// Lightbox
const lightbox=document.getElementById('lightbox');
const lbImg=document.getElementById('lbImg');
const lbCaption=document.getElementById('lbCaption');
const lbCounter=document.getElementById('lbCounter');
let lbIdx=0,lbItemId=0;

function openLightbox(itemId,imgIdx){
  lbItemId=itemId;lbIdx=imgIdx;
  updateLightbox();
  lightbox.classList.add('show');
  document.body.style.overflow='hidden';
}
function updateLightbox(){
  const imgs=photos[lbItemId]||[];
  if(!imgs.length){lightbox.classList.remove('show');return;}
  const imgData=imgs[lbIdx];
  lbImg.src=imgData?.url||imgData;
  // Find item by ID for caption
  const item=items.find(item=>item.id===lbItemId);
  lbCaption.textContent=item?item.name:'Unknown Item';
  lbCounter.textContent=imgs.length>1?`${lbIdx+1} / ${imgs.length}`:'';
  document.getElementById('lbPrev').style.display=imgs.length>1?'flex':'none';
  document.getElementById('lbNext').style.display=imgs.length>1?'flex':'none';
}
function closeLightbox(){lightbox.classList.remove('show');document.body.style.overflow='';}
document.getElementById('lbClose').addEventListener('click',closeLightbox);
document.getElementById('lbPrev').addEventListener('click',()=>{const len=photos[lbItemId]?.length||0;lbIdx=(lbIdx-1+len)%len;updateLightbox();});
document.getElementById('lbNext').addEventListener('click',()=>{const len=photos[lbItemId]?.length||0;lbIdx=(lbIdx+1)%len;updateLightbox();});
lightbox.addEventListener('click',e=>{if(e.target===lightbox)closeLightbox();});
document.addEventListener('keydown',e=>{
  if(!lightbox.classList.contains('show'))return;
  if(e.key==='Escape')closeLightbox();
  if(e.key==='ArrowLeft'){const len=photos[lbItemId]?.length||0;lbIdx=(lbIdx-1+len)%len;updateLightbox();}
  if(e.key==='ArrowRight'){const len=photos[lbItemId]?.length||0;lbIdx=(lbIdx+1)%len;updateLightbox();}
});

// Bulk upload
// === Reorder Photos Modal ===
const reorderModal=document.getElementById('reorderModal');
const reorderList=document.getElementById('reorderList');
const reorderCancel=document.getElementById('reorderCancel');
const reorderSaveBtn=document.getElementById('reorderSave');
let reorderItemId=null;
let reorderItems=[];

function openReorderModal(itemId){
  reorderItemId=itemId;
  const photoData=photos[itemId]||[];
  reorderItems=photoData.map((photo,i)=>({
    src:photo.url||photo,
    id:photo.id,
    origIdx:i
  }));
  renderReorderRows();
  reorderModal.classList.add('show');
}

function renderReorderRows(){
  reorderList.innerHTML='';
  reorderItems.forEach((item,i)=>{
    const row=document.createElement('div');
    row.className='reorder-row';
    row.draggable=true;
    row.setAttribute('data-ri',i);
    row.innerHTML=`<span class="order-num">${i+1}</span><img src="${item.src}"><span style="font-size:.85rem;color:#6b7280">${i===0?'(Cover photo)':''}</span>`;
    reorderList.appendChild(row);
  });
  initReorderDrag();
}

let reorderDragSrc=null;
function initReorderDrag(){
  reorderList.querySelectorAll('.reorder-row').forEach(row=>{
    row.addEventListener('dragstart',e=>{
      reorderDragSrc=row;
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
    });
    row.addEventListener('dragend',()=>{
      row.classList.remove('dragging');
      reorderList.querySelectorAll('.drag-over').forEach(r=>r.classList.remove('drag-over'));
    });
    row.addEventListener('dragover',e=>{
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
      if(row!==reorderDragSrc){
        reorderList.querySelectorAll('.drag-over').forEach(r=>r.classList.remove('drag-over'));
        row.classList.add('drag-over');
      }
    });
    row.addEventListener('dragleave',()=>row.classList.remove('drag-over'));
    row.addEventListener('drop',e=>{
      e.preventDefault();
      row.classList.remove('drag-over');
      if(reorderDragSrc&&reorderDragSrc!==row){
        const fromIdx=parseInt(reorderDragSrc.getAttribute('data-ri'));
        const toIdx=parseInt(row.getAttribute('data-ri'));
        const [moved]=reorderItems.splice(fromIdx,1);
        reorderItems.splice(toIdx,0,moved);
        renderReorderRows();
      }
    });
  });
}

reorderCancel.addEventListener('click',()=>{reorderModal.classList.remove('show');});

reorderSaveBtn.addEventListener('click',async()=>{
  // Get the new order of photo IDs
  const photoIds=reorderItems.map(item=>item.id).filter(Boolean);
  
  if(photoIds.length){
    const success=await reorderPhotos(reorderItemId,photoIds);
    if(success){
      // Update local photos array with new order
      photos[reorderItemId]=reorderItems.map(item=>({
        id:item.id,
        url:item.src
      }));
      slidePos[reorderItemId]=0;
    }
  }
  
  reorderModal.classList.remove('show');
  const activeTab=tabsEl.querySelector('button.active').textContent;
  render(activeTab);
});

// === Bulk Upload ===
const bulkUpload=document.getElementById('bulkUpload');
const bulkInput=document.getElementById('bulkInput');
const bulkModal=document.getElementById('bulkModal');
const bulkAssignList=document.getElementById('bulkAssignList');
const bulkCancel=document.getElementById('bulkCancel');
const bulkSave=document.getElementById('bulkSave');
let bulkPending=[];

bulkUpload.addEventListener('click',()=>bulkInput.click());
bulkUpload.addEventListener('dragover',e=>{e.preventDefault();bulkUpload.style.borderColor='#0f3460';});
bulkUpload.addEventListener('dragleave',()=>{bulkUpload.style.borderColor='#d1d5db';});
bulkUpload.addEventListener('drop',e=>{e.preventDefault();bulkUpload.style.borderColor='#d1d5db';handleBulkFiles(Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/')));});

bulkInput.addEventListener('change',e=>handleBulkFiles(Array.from(e.target.files)));

function handleBulkFiles(files){
  if(!files.length)return;
  bulkPending=[];
  let loaded=0;
  const optionsHTML=items.map(item=>`<option value="${item.id}">${item.name} (${item.category})</option>`).join('');

  files.forEach((file,fi)=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      compressImage(ev.target.result).then(compressed=>{
      bulkPending[fi]={src:compressed,itemId:items[0]?.id||1}; // default to first item
      loaded++;
      if(loaded===files.length){
        renderBulkRows();
        bulkModal.classList.add('show');
      }
      });
    };
    reader.readAsDataURL(file);
  });
}

function renderBulkRows(){
  const optionsHTML=items.map(item=>`<option value="${item.id}">${item.name} (${item.category})</option>`).join('');
  bulkAssignList.innerHTML='';
  bulkPending.forEach((p,pi)=>{
    const row=document.createElement('div');
    row.className='assign-row';
    row.draggable=true;
    row.setAttribute('data-pi',pi);
    row.innerHTML=`<span class="order-num">${pi+1}</span><img src="${p.src}"><select data-pi="${pi}">${optionsHTML}</select>`;
    // restore selection if set
    if(p.itemId!==undefined)row.querySelector('select').value=p.itemId;
    bulkAssignList.appendChild(row);
  });
  initBulkDrag();
}

let dragSrcRow=null;
function initBulkDrag(){
  const rows=bulkAssignList.querySelectorAll('.assign-row');
  rows.forEach(row=>{
    row.addEventListener('dragstart',e=>{
      dragSrcRow=row;
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
    });
    row.addEventListener('dragend',()=>{
      row.classList.remove('dragging');
      bulkAssignList.querySelectorAll('.drag-over').forEach(r=>r.classList.remove('drag-over'));
    });
    row.addEventListener('dragover',e=>{
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
      if(row!==dragSrcRow){
        bulkAssignList.querySelectorAll('.drag-over').forEach(r=>r.classList.remove('drag-over'));
        row.classList.add('drag-over');
      }
    });
    row.addEventListener('dragleave',()=>row.classList.remove('drag-over'));
    row.addEventListener('drop',e=>{
      e.preventDefault();
      row.classList.remove('drag-over');
      if(dragSrcRow&&dragSrcRow!==row){
        // save selections
        bulkAssignList.querySelectorAll('select').forEach(s=>{
          const pi=parseInt(s.getAttribute('data-pi'));
          bulkPending[pi].idx=parseInt(s.value);
        });
        // reorder bulkPending
        const fromIdx=parseInt(dragSrcRow.getAttribute('data-pi'));
        const toIdx=parseInt(row.getAttribute('data-pi'));
        const [moved]=bulkPending.splice(fromIdx,1);
        bulkPending.splice(toIdx,0,moved);
        renderBulkRows();
      }
    });
  });
}

bulkCancel.addEventListener('click',()=>{bulkModal.classList.remove('show');bulkInput.value='';});

bulkSave.addEventListener('click',async()=>{
  const rows=Array.from(bulkAssignList.querySelectorAll('.assign-row'));
  
  for(const row of rows) {
    const pi=parseInt(row.getAttribute('data-pi'));
    const sel=row.querySelector('select');
    const itemId=parseInt(sel.value);
    
    const newPhoto=await addPhotoToDB(itemId,bulkPending[pi].src);
    if(newPhoto) {
      if(!photos[itemId])photos[itemId]=[];
      photos[itemId].push({id:newPhoto.id, url:newPhoto.photo_url||newPhoto.url, sort_order:newPhoto.sort_order});
    }
  }
  
  bulkModal.classList.remove('show');
  bulkInput.value='';
  const activeTab=tabsEl.querySelector('button.active').textContent;
  render(activeTab);
});

// Add Item modal
const addModal=document.getElementById('addModal');
const addCatSelect=document.getElementById('addCat');
// Populate category dropdown (skip "All")
cats.filter(c=>c!=='All').forEach(c=>{
  const opt=document.createElement('option');opt.value=c;opt.textContent=c;
  addCatSelect.appendChild(opt);
});

// Handle add item card click (delegated since it's re-rendered)
gridEl.addEventListener('click',e=>{
  if(e.target.closest('.add-item-card')){
    document.getElementById('addName').value='';
    document.getElementById('addDesc').value='';
    document.getElementById('addPrice').value='';
    addCatSelect.value=cats[1];// default to first real category
    // If we're on a specific tab, pre-select that category
    const activeTab=tabsEl.querySelector('button.active').textContent;
    if(activeTab!=='All')addCatSelect.value=activeTab;
    addModal.classList.add('show');
  }
});

document.getElementById('addCancel').addEventListener('click',()=>addModal.classList.remove('show'));
document.getElementById('addSave').addEventListener('click',async()=>{
  const name=document.getElementById('addName').value.trim();
  if(!name){alert('Please enter an item name');return;}
  const category=addCatSelect.value;
  const description=document.getElementById('addDesc').value.trim()||'No description yet.';
  const price=document.getElementById('addPrice').value.trim()||'Contact for price';
  
  const newItem=await fetchAPI('items',{
    method:'POST',
    body:JSON.stringify({name,category,description,price})
  });
  
  if(newItem){
    items.push(newItem);
    photos[newItem.id]=[];
    slidePos[newItem.id]=0;
    addModal.classList.remove('show');
    const activeTab=tabsEl.querySelector('button.active').textContent;
    render(activeTab);
  }
});

cats.forEach(c=>{
  const b=document.createElement("button");
  b.textContent=c;
  if(c==="All")b.classList.add("active");
  b.onclick=()=>{
    tabsEl.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.getElementById('grid').style.display='';
    document.getElementById('listView').classList.remove('active');
    render(c);
  };
  tabsEl.appendChild(b);
});
// Add List tab
const listBtn=document.createElement("button");
listBtn.textContent="üìã List";
listBtn.onclick=()=>{
  tabsEl.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
  listBtn.classList.add("active");
  document.getElementById('grid').style.display='none';
  document.getElementById('listView').classList.add('active');
  renderListView();
};
tabsEl.appendChild(listBtn);

function renderListView(){
  const lv=document.getElementById('listView');
  lv.innerHTML='';
  if(!items.length){lv.innerHTML='<div style="text-align:center;padding:3rem;color:#9ca3af">No items yet</div>';return;}
  items.forEach(item=>{
    const status=item.status||'available';
    const statusText=status==='sold'?'Sold':'Available';
    const row=document.createElement('div');
    row.className='list-row';
    row.innerHTML=`<span class="row-name">${item.name}</span><span class="row-desc">${item.description||'No description'}</span><span class="row-cat">${item.category}</span><span class="row-status ${status}">${statusText}</span><span class="row-price">${item.price||'Contact'}</span>`;
    row.onclick=()=>{
      // Switch back to grid view and scroll to the card
      tabsEl.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
      tabsEl.querySelector("button").classList.add("active"); // activate "All"
      document.getElementById('grid').style.display='';
      document.getElementById('listView').classList.remove('active');
      render("All");
      setTimeout(()=>{
        const card=document.querySelector(`.card[data-item-id="${item.id}"]`);
        if(card){card.scrollIntoView({behavior:'smooth',block:'center'});card.style.boxShadow='0 0 0 3px #0f3460';setTimeout(()=>card.style.boxShadow='',2000);}
      },100);
    };
    lv.appendChild(row);
  });
}
// Bulk download all photos as ZIP
document.getElementById('bulkDownload').addEventListener('click', async () => {
  if (typeof JSZip === 'undefined') { alert('ZIP library not loaded yet, try again in a moment.'); return; }
  const zip = new JSZip();
  let totalPhotos = 0;

  for (const item of items) {
    const imgs = photos[item.id] || [];
    if (!imgs.length) continue;
    const folderName = item.name.replace(/[\\/:*?"<>|]/g, '_');
    const folder = zip.folder(folderName);
    imgs.forEach((photoData, i) => {
      const dataUrl = photoData.url || photoData;
      const base64 = dataUrl.split(',')[1];
      const ext = dataUrl.startsWith('data:image/png') ? 'png' : 'jpg';
      folder.file(`${folderName}_${i + 1}.${ext}`, base64, { base64: true });
      totalPhotos++;
    });
  }

  if (totalPhotos === 0) { alert('No photos to download yet!'); return; }

  const btn = document.getElementById('bulkDownload');
  btn.querySelector('h3').textContent = 'Creating ZIP...';

  try {
    const blob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'moving-sale-photos.zip';
    a.click();
    URL.revokeObjectURL(url);
    btn.querySelector('h3').textContent = 'Download All Photos';
  } catch (e) {
    alert('Error creating ZIP: ' + e.message);
    btn.querySelector('h3').textContent = 'Download All Photos';
  }
});

// Delegate move button clicks on the grid
gridEl.addEventListener('click',e=>{
  const btn=e.target.closest('.move-up-btn,.move-down-btn,.move-right-btn,.move-left');
  if(!btn)return;
  e.stopPropagation();
  const itemId=parseInt(btn.getAttribute('data-item-id'));
  if(btn.classList.contains('move-up-btn')){
    moveItem(itemId,'up',getGridCols());
  } else if(btn.classList.contains('move-down-btn')){
    moveItem(itemId,'down',getGridCols());
  } else if(btn.classList.contains('move-left')){
    moveItem(itemId,'up',1);
  } else if(btn.classList.contains('move-right-btn')){
    moveItem(itemId,'down',1);
  }
});

// Initialize the app
async function initApp() {
  await loadData();
  render("All");
}

// Deposit popup - show once per session
const depositPopup = document.getElementById('depositPopup');
const popupClose = document.getElementById('popupClose');
if(sessionStorage.getItem('depositPopupSeen')){
  depositPopup.classList.add('hidden');
}
popupClose.addEventListener('click',()=>{
  depositPopup.classList.add('hidden');
  sessionStorage.setItem('depositPopupSeen','1');
});
depositPopup.addEventListener('click',e=>{
  if(e.target===depositPopup){depositPopup.classList.add('hidden');sessionStorage.setItem('depositPopupSeen','1');}
});

// Late pickup items - tag these in the render
const LATE_PICKUP_28MAR = ['fridge','lounge chair','double bed','bed #1','bed #2','bundle deal','honda','accord'];
const LATE_PICKUP_24MAR = ['washer','dryer','laundry combo'];

// Start the app
initApp().catch(error => {
  console.error('Failed to initialize app:', error);
  render("All"); // Fallback to render empty grid
});
</script>
</body>
</html>
